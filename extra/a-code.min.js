/**
 * @author Holmes Bryant <https://github.com/HolmesBryant>
 * @license GPL-3.0
 */
class t extends HTMLElement{_edit=!1;_highlight=!1;_inline=!1;_indent=4;_lineNumbers=!1;_palette=null;#t;contentNode;#e=null;#i=Date.now();lineNumberElem;#s;#n;highlighter;defaults={};static observedAttributes=["highlight","inline","indent","line-numbers"];static template='\n    <style>\n      :host {\n        --indent: 1;\n        --line-number-color: gray;\n        --wrap: pre;\n        display: block;\n        max-width: 100%;\n        vertical-align: top;\n      }\n\n      :host([inline]) {\n        display: inline-block;\n        padding: 0;\n      }\n\n      section {\n        display: inline-grid;\n        gap: .5rem;\n        grid-template-columns: max-content 1fr;\n        width: 100%;\n      }\n\n      #content {\n        font-family: "Courier New", monospace;\n        tab-size: var(--indent);\n        white-space: var(--wrap);\n        overflow: auto;\n      }\n\n      #line-numbers {\n        color: var(--line-number-color);\n        font-family: "Courier New", monospace;\n        white-space: pre-line;\n      }\n    </style>\n\n    <section part="section">\n      <div id="line-numbers" part="line-numbers"></div>\n      <div id="content" part="content"><slot></slot></div>\n    </section>\n  ';constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=t.template}attributeChangedCallback(t,e,i){switch(t){case"highlight":this.#h(i);break;case"inline":i=null!==i&&"false"!==i&&!1!==i,this.#r(i);break;case"indent":this.style.setProperty("--indent",i),this._indent=i,window.abind&&abind.update(this,"indent",i);break;case"line-numbers":this.#l(i)}}connectedCallback(){this.contentNode=this.shadowRoot.querySelector("#content"),this.lineNumberElem=this.shadowRoot.querySelector("#line-numbers"),this.#t=new AbortController,this.#s=new MutationObserver(this.#o.bind(this));const t=this.#a(this.#d());this.textContent=t,this.#e=t,this.lineNumbers&&this.#g(),this.highlight&&this.#c(),this.#u(),this.#s.observe(this,{childList:!0,subtree:!0,characterData:!0})}disconnectedCallback(){this.#t&&(this.#t.abort(),this.#t=null),this.#s&&(this.#s.disconnect(),this.#s=null),this.#b(),this.highlighter=null,this._palette=null,this.contentNode=null,this.lineNumberElem=null}#g(){if(!this.lineNumberElem)return;const t=this.textContent.split(/\r?\n/).length;let e="";for(let i=1;i<=t;i++)e+=`${i}\n`;this.lineNumberElem.innerHTML=e.trim()}#m(t){const e=document.createElement("textarea");return e.innerHTML=t,e.value}#b(){if(this.highlighter)try{this.highlighter.destroy()}catch(t){console.error(t)}}#o(t=250){clearTimeout(this.#n),this.#n=setTimeout((()=>this.#p()),t)}#d(){return this.children[0]&&"textarea"===this.children[0].localName?this.textContent.replace("\\/","/"):this.#m(this.innerHTML)}#c(t=this.highlight,e=this.palette){if(!1!==t){this.highlighter=new i(this,t,e);try{this.highlighter.highlight(this.childNodes[0])}catch(t){throw t}}}#f(){this.lineNumberElem&&(this.lineNumberElem.innerHTML="")}reset(){for(const t of ABind.observedAttributes)this[t]=this.defaults[t]}#a(t){this.needsUpdate=!1,t=t.replace(/^ +/gm,(t=>"\t".repeat(t.length))).trim();const e=t.split("\n"),i=e.at(-1).match(/^\s*/)[0].length,s=new RegExp(`^\\s{${i}}`,"g");return e.map((t=>t.replace(s,""))).join("\n")}#u(){if(!(Object.keys(this.defaults).length>0))for(const e of t.observedAttributes)this.defaults[e]=this[e]}#h(t){switch(t){case"false":case!1:this._highlight=!1,this.highlighter&&this.highlighter.deleteCssHighlights();break;case"":case null:this._highlight="html";break;default:this._highlight=t}!1!==this._highlight&&this.highlighter&&this.highlighter.setHighlights(t),window.abind&&abind.update(this,"highlight",t)}#r(t){!0===t?(this.style.setProperty("--wrap","nowrap"),this.lineNumbers=!1):(this.style.removeProperty("--wrap"),this.hasAttribute("line-numbers")&&(this.lineNumbers=this.getAttribute("line-numbers"))),this._inline=t,window.abind&&abind.update(this,"inline",t)}#l(t){t=null!==t&&"false"!==t&&!1!==t,this._lineNumbers=t,!0===t?this.#g():this.#f(),window.abind&&abind.update(this,"lineNumbers",t)}#p(){const t=this.#a(this.#d());t!==this.#e&&(this.#e=t,this.textContent=t,this.highlighter&&this.#b(),this.lineNumbers&&this.#g(),this.highlight&&requestAnimationFrame((()=>this.#c())))}get abortController(){return this.#t}get observer(){return this.#s}get inline(){return this._inline}set inline(t){t=""!==t&&"false"!==t&&!1!==t,this.toggleAttribute("inline",t)}get indent(){return this._indent}set indent(t){t||(t=this.defaults.indent),this.setAttribute("indent",t)}get highlight(){return this._highlight}set highlight(t){t||(t=this.defaults.highlight),this.setAttribute("highlight",t)}get lineNumbers(){return this._lineNumbers}set lineNumbers(t){t=null!==t&&"false"!==t&&!1!==t,this.toggleAttribute("line-numbers",t)}get palette(){return this._palette}set palette(t){if(t instanceof Map);else try{t=new Map(JSON.parse(t))}catch(e){return console.error(`Error setting palette: ${e} | ${t}`)}this._palette=t,this.highlighter&&this.highlighter.setPalette(t)}}const e=new Map;class i{#y=null;#w;#S={argument:/(?<=\()[^)]+/g,function:/[\w-]+\s*\(|\)/g,operator:/[>+~*\/=]|(?<!\w[-])/g,property:/(?<!}[\r\n\s]+)\b([\w\d-]+:(?!:))/g,number:/(?<!\w)[#+-.]?\d+[%.A-Za-z]*/g,tag:/<\/?[\w-]+|(?<=[\w"])>/g,string:/["'`][^"'`]*["'`]/g,variable:/--[\w\d]+-?[\w\d]*/g,comment:/(<!--|\/\*)([\s\S]*?)(-->|\*\/)/g,keyword:/@[\w]+\b/g};#N;#C;#x=new Map([["argument","hsl(32, 93%, 66%)"],["comment","hsl(221, 12%, 69%)"],["function","hsl(210, 50%, 60%)"],["keyword","deeppink"],["number","hsl(32, 93%, 50%)"],["operator","red"],["property","orchid"],["string","hsl(114, 31%, 68%)"],["variable","darkkhaki"],["tag","indianred"]]);#v;#E;constructor(t,e,i,s){if(!(t instanceof HTMLElement))throw new Error("element passed to Highlighter must be an HTML element");this.#y=e||this.#y,this.#C=i||this.#x,this.#N=s||Math.random().toString(36).substring(2,9),this.#v=this.#H();(t.shadowRoot&&"open"===t.shadowRoot.mode?t.shadowRoot:t.attachShadow({mode:"open"})).adoptedStyleSheets=[this.#v],document.adoptedStyleSheets=[...document.adoptedStyleSheets,this.#v]}#H(){const t=this.#v?this.#v:new CSSStyleSheet;let e="";return this.#C.forEach(((t,i)=>{const s=`${i}-${this.#N}`;e+=`::highlight(${s}) { color: ${t}}`})),t.replaceSync(e),t}deleteCssHighlights(){for(const t of Object.keys(this.#w)){const e=`${t}-${this.#N}`;CSS.highlights.delete(e)}}destroy(){this.deleteCssHighlights(),document.adoptedStyleSheets=document.adoptedStyleSheets.filter((t=>t!==this.#v))}#T(t,e){if(e.nodeType!==Node.TEXT_NODE)throw new Error(`Second argument must be a TEXT_NODE (3). Given nodeType is (${e.nodeType})`);let i;const s=e.textContent;for(const n of Object.keys(t)){const h=t[n];if(h){if(Array.isArray(h)){const t=[...new Set(h)].join("|"),n=new RegExp(`\\b(${t})\\b`,"g");i=this.#_(n,s,e)}else if(h instanceof Function)i=new Set(h(s,e));else{if(!(h instanceof RegExp)){console.error(`Invalid syntaxObj definition for ${n}: `,`"${h}"`);continue}i=this.#_(h,s,e)}this.#h(i,n)}}return CSS.highlights.size}async#L(t){let i;if("string"==typeof t)if(e.has(t))i=e.get(t);else{let s=t;/^(http|\.|\/)/.test(t)||(s=`./syntax.${t}.js`);try{const n=await import(s);e.set(t,n.default),i=n.default}catch(t){throw console.error("Error loading Highlight Syntax"),t}}else try{i=t,e.set(t,t)}catch(s){i=this.defaultSyntaxDefs,e.set(t,i),console.error("Error loading syntax definition. Using defaults: ",s)}return i}async highlight(t){t&&t.nodeType!==Node.TEXT_NODE&&(t=document.createTextNode(t.textContent)),t=t||this.#E,this.#E||(this.#E=t),this.#y&&"html"!==this.#y?this.#w=await this.#L(this.#y):this.#w=this.#S;try{this.#T(this.#w,t)}catch(t){throw console.error("Error highlighting code: "),t}}#h(t,e){const i=`${e}-${this.#N}`,s=new Highlight(...t);CSS.highlights.set(i,s)}setHighlights(t){this.deleteCssHighlights(),this.#y=t,this.highlight()}setPalette(t){if(t instanceof Map&&0===t.size)t=this.#x;else if(!(t instanceof Map))try{const e=JSON.parse(t);t=new Map(e)}catch(e){return console.error(`Error setting palette: ${e}`,t)}this.#C=t,this.#H()}#_(t,e,i){const s=new Set,n=e.matchAll(t);for(const t of n){if(0===t[0].length)continue;const e=t.index,n=e+t[0].length,h=new Range;h.setStart(i,e),h.setEnd(i,n),s.add(h)}return s}}document.addEventListener("DOMContentLoaded",(()=>{customElements.get("a-code")||customElements.define("a-code",t)}));export{t as ACode,i as Highlighter};
