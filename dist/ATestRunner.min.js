/**
 * @author Holmes Bryant <https://github.com/HolmesBryant>
 * @version 3.0.2
 * @license MIT
 */
class ATestRunner{currentLine=null;onlyFailed=!1;timeout=2e3;resultEventName="a-testresult";progressEventName="a-progress";completeEventName="a-complete";#e=Promise.resolve();#t="pass";#s;#r=[];#o;#i="console";#n=null;constructor(e){this.#s=e,this.#o=new ConsoleReporter,this.equal=this.equal.bind(this),this.group=this.group.bind(this),this.info=this.info.bind(this),this.log=this.log.bind(this),this.skip=this.skip.bind(this),this.test=this.test.bind(this),this.when=this.when.bind(this),this.profile=this.profile.bind(this),this.run=this.run.bind(this)}async benchmark(e,t=1,s=null,...r){const o=performance.now();for(let o=0;o<t;o++)await e.apply(s,r);return performance.now()-o}equal(e,t){const s=new Map;return this.#l(e,t,s)}*genCombos(e={}){const t=Object.keys(e),s=Object.values(e);yield*function*e(r,o){if(r===t.length)return void(yield{...o});const i=t[r],n=s[r];if(Array.isArray(n))for(const t of n)o[i]=t,yield*e(r+1,o);else o[i]=n,yield*e(r+1,o)}(0,{})}group(e,t){this.#e=this.#e.then(async()=>{this.#r.push({type:"group_start",payload:{gist:e}}),await t(),this.#r.push({type:"group_end",payload:{}})})}handleError(e,t={}){let s;const r=t.code??null,o=t.line??this.currentLine??(this.#s?this.#a():null);s=t.gist?t.gist:r?`Failed to execute:\n${r}`:"Error during setup",this.#r.push({type:"test",payload:{gist:s,testFn:e,expect:null,line:o,verdict:"error"}})}info(e){this.#r.push({type:"info",payload:{message:e}})}log(e,t){this.#r.push({type:"custom_log",payload:{verdict:e,message:t}})}async profile(e,t,s=this,...r){let o=this[e];return o||("executeTest"===e?o=this.#u:"getLine"===e&&(o=this.#a)),this.benchmark(o,t,s,...r)}skip(e,t,s){const r=this.currentLine??(this.#s?this.#a():null);this.#r.push({type:"skip",payload:{gist:e,testFn:t,expect:s,line:r,verdict:"skip"}})}spyOn(e,t){const s=e[t];if("function"!=typeof s)throw new Error(`'${t}' must be a function on the object.`);let r=s;const o={callCount:0,calls:[],restore:()=>{e[t]=s},runs(e){return r=e,this},returns(e){return r=()=>e,this},resolves(e){return r=()=>Promise.resolve(e),this},rejects(e){return r=()=>Promise.reject(e),this}};return e[t]=function(...e){return o.callCount++,o.calls.push(e),r.apply(this,e)},o}test(e,t,s,r={}){const o={gist:e,testFn:t,expect:s,line:this.currentLine??(this.#s?this.#a():null),...r};this.#r.push({type:"test",payload:o})}throws(e,...t){try{return e(...t),!1}catch(e){return!0}}async wait(e){return new Promise(t=>setTimeout(t,e))}async when(e,t=1e3,s=100){const r=Date.now(),o="function"==typeof e?async()=>e():async()=>e;for(;;){if(Date.now()-r>=t)return await o();try{const e=await o();if(e)return e}catch(e){throw e}await this.wait(s)}}async run(){await this.#e,await this.#c(),this.#o.progress(0,this.#r.length),await this.#p(),this.#o.complete(this.#t)}#h(e){this.#e=this.#e.then(e)}#g(e){return"info"===e.type?Promise.resolve({type:"info",message:e.payload.message}):"custom_log"===e.type?Promise.resolve({type:"custom_log",verdict:e.payload.verdict,result:e.payload.message}):this.#u(e.payload)}async#u(e){const{gist:t,testFn:s,expect:r,line:o,verdict:i,timeout:n}=e,l=n??this.timeout;try{if(i)return{type:"test",gist:t,verdict:i,result:"error"===i?s:"Not executed",expect:r,line:o};const e=new Promise((e,t)=>setTimeout(()=>t(new Error(`Test timed out after ${l}ms`)),l)),n=(async()=>{const e="function"==typeof s?s():s;if(e instanceof Error)return{type:"test",gist:t,verdict:"error",result:e,expect:r,line:o};const i=await e,n=this.equal(i,r)?"pass":"fail";return{type:"test",gist:t,verdict:n,result:i,expect:r,line:o}})();return await Promise.race([n,e])}catch(e){return{type:"test",gist:t,verdict:"error",result:e,expect:r,line:o}}}#a(){try{throw new Error}catch(e){if(!e.stack)return null;const t=e.stack.split("\n").find(e=>e.includes(this.#s));if(!t)return null;const s=t.indexOf(this.#s)+this.#s.length+1,r=t.lastIndexOf(":");return t.substring(s,r)}}async#p(){const e=[[]];let t=!1;for(const[s,r]of this.#r.entries()){switch(r.type){case"group_start":this.#o.groupStart(r.payload.gist),t=!0;break;case"group_end":const s=e[e.length-1];await this.#f(s),s.length=0,this.#o.groupEnd(),t=!1;break;default:const o=this.#g(r);if(t)e[e.length-1].push(o);else{const e=await o;this.#d(e)}}this.#o.progress(s+1,this.#r.length)}}async#f(e){const t=await Promise.all(e);for(const e of t)this.#d(e)}#d(e){"fail"!==e.verdict&&"error"!==e.verdict||(this.#t="fail"),this.onlyFailed&&"pass"===e.verdict||this.#o.report(e)}async#c(){if("console"===this.#i||null===this.#i)return this.#n="console",void(this.#o=new ConsoleReporter);let e;if(this.#i instanceof HTMLElement?e=this.#i:"string"==typeof this.#i&&(e=document.querySelector(this.#i)),!e)throw new Error(`ATestRunner Error: Output target "${this.#i}" not found in the DOM.`);if(e.localName.includes("-"))try{await customElements.whenDefined(e.localName),await new Promise(e=>requestAnimationFrame(e))}catch(t){console.warn(`ATestRunner: Could not wait for custom element '${e.localName}' to be defined. It may not have been registered.`,t)}this.#n=e,this.#o=new EventReporter(e,{result:this.resultEventName,progress:this.progressEventName,complete:this.completeEventName})}#l(e,t,s){return e===t||null!==e&&"object"==typeof e&&null!==t&&"object"==typeof t&&(!(!s.has(e)||s.get(e)!==t)||(s.set(e,t),Object.getPrototypeOf(e)===Object.getPrototypeOf(t)&&(e instanceof Date?e.getTime()===t.getTime():e instanceof RegExp?e.toString()===t.toString():Array.isArray(e)?this.#m(e,t,s):e instanceof Map?this.#y(e,t,s):e instanceof Set?this.#w(e,t,s):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.#b(e,t):this.#E(e,t,s))))}#m(e,t,s){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!this.#l(e[r],t[r],s))return!1;return!0}#y(e,t,s){if(e.size!==t.size)return!1;for(const[r,o]of e)if(!t.has(r)||!this.#l(o,t.get(r),s))return!1;return!0}#w(e,t,s){if(e.size!==t.size)return!1;const r=[...t];for(const t of e){const e=r.findIndex(e=>this.#l(t,e,s));if(-1===e)return!1;r.splice(e,1)}return!0}#b(e,t){if(e.byteLength!==t.byteLength)return!1;const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(let t=0;t<e.byteLength;t++)if(s[t]!==r[t])return!1;return!0}#E(e,t,s){const r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;for(const o of r)if(!Object.prototype.hasOwnProperty.call(t,o)||!this.#l(e[o],t[o],s))return!1;return!0}get output(){return this.#i}set output(e){this.#i=e}get finalVerdict(){return this.#t}}class ATestReporter{report(e){throw new Error("ATestReporter.report() must be implemented by subclasses.")}groupStart(e){throw new Error("ATestReporter.groupStart() must be implemented by subclasses.")}groupEnd(){throw new Error("ATestReporter.groupEnd() must be implemented by subclasses.")}progress(e,t){throw new Error("ATestReporter.progress() must be implemented by subclasses.")}complete(e){throw new Error("ATestReporter.complete() must be implemented by subclasses.")}}class ConsoleReporter extends ATestReporter{#v(e){switch(e){case"pass":return"color:limegreen; font-weight:bold";case"fail":return"color:red; font-weight:bold";case"info":return"color:SandyBrown; font-weight:bold";case"GROUP_START":return"color:darkorange; font-weight:bold";case"error":return"color:fuchsia; font-weight:bold;";default:return"color:dodgerblue; font-weight:bold"}}report(e){const{gist:t,verdict:s,result:r,expect:o,line:i,message:n,type:l}=e;if("custom_log"===l)return console.groupCollapsed(s),console.log(r),void console.groupEnd();if("info"===l)return void console.log("%cINFO",this.#v("info"),n);const a=[`%c${s.toUpperCase()}`,this.#v(s),t];console.groupCollapsed(...a),console.log("Result:",r),console.log("Expected:",o),i&&console.log("Line:",i),console.groupEnd()}groupStart(e){console.group(`%c${e}`,this.#v("GROUP_START"))}groupEnd(){console.groupEnd()}progress(e,t){}complete(e){console.log("%cDONE",this.#v("done"))}}class EventReporter extends ATestReporter{#R;#T;#A;#C;constructor(e,t){super(),this.#R=e,this.#T=t.result,this.#A=t.progress,this.#C=t.complete}#O(e,t){const s=new CustomEvent(e,{detail:t,bubbles:!0,composed:!0});this.#R.dispatchEvent(s)}#N(e){if("custom_log"===e.type){let t=e.result;if(t instanceof Element){const e={};for(const s of t.attributes)e[s.name]=s.value;const s={tagName:t.tagName.toLowerCase(),attributes:e};"value"in t&&(s.value=t.value),t=s}else"object"==typeof t&&null!==t&&(t=Array.isArray(t)?[...t]:{...t});return{gist:null,verdict:e.verdict,result:t}}const{gist:t,verdict:s,result:r,expect:o,line:i,message:n,type:l}=e,a="info"===l?{gist:n,verdict:"INFO"}:{gist:t,verdict:s.toUpperCase(),result:r,expect:o,line:i};return a.result instanceof Error&&(a.result=a.result.stack?a.result.stack.split("\n"):a.result.message),a}report(e){this.#O(this.#T,this.#N(e))}groupStart(e){this.#O(this.#T,{gist:e,verdict:"GROUP_START"})}groupEnd(){this.#O(this.#T,{gist:null,verdict:"GROUP_END"})}progress(e,t){const s=new ProgressEvent(this.#A,{lengthComputable:!0,loaded:e,total:t});this.#R.dispatchEvent(s)}complete(e){this.#O(this.#C,{verdict:e})}}export{ATestRunner as default};
